// ==UserScript==
// @name MyAnimeStream
// @author siku2
// @version 1.0.1
// @description Get the most out of MyAnimeList by turning the page into a streaming site.
// @homepage https://siku2.github.io/
// @downloadURL https://github.com/siku2/InScripts/raw/master/scripts/MyAnimeStream/Deities/dist/myanimestream.user.js
// @icon https://myanimelist.cdn-dena.com/img/sp/icon/apple-touch-icon-256.png
// @include /^http(?:s)?\:\/\/myanimelist\.net.*$/
// @run-at document-start
// @require https://code.jquery.com/jquery-3.2.1.min.js
// @require https://cdn.ravenjs.com/3.25.1/raven.min.js
// @require https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js
// @require https://cdn.plyr.io/3.3.10/plyr.js
// ==/UserScript==
let route=(()=>{var e=_asyncToGenerator(function*(){const e=window.location.pathname,n=window.location.search;if(settingPaths.indexOf(e)>-1&&addSettingsButton(),e.match(/^\/anime\/\d+\/[\w-]+\/?/)){if(patchNoEpisodeTab(),!(yield getAnimeInfo()))return void _animeNotFoundMsg()}e.match(/^\/anime\/\d+\/[\w-]+\/?$/)?showAnimeDetails():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/?$/)?yield showAnimeEpsiodes():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/\d+\/?$/)?yield showAnimeEpisode():e.match(/^\/animelist\/\w+$/)?yield highlightAnimeWithUnwatchedEpisodes():e.match(/^\/editprofile\.php$/)&&n.match(/^\?go=myanimestream$/)&&(yield showSettings())});return function(){return e.apply(this,arguments)}})(),postJSON=(()=>{var e=_asyncToGenerator(function*(e,n){return yield $.ajax({type:"POST",contentType:"application/json",url:e,data:JSON.stringify(n)})});return function(n,t){return e.apply(this,arguments)}})(),showAnimeEpisode=(()=>{var e=_asyncToGenerator(function*(){const e=parseInt(window.location.pathname.match(/^\/anime\/\d+\/[\w-]+\/episode\/(\d+)\/?$/)[1]),n=$("div.video-embed.clearfix");if(n.length>0){console.log("Manipulating existing video embed");const t=grobberUrl+"/stream/"+animeUID+"/"+(e-1).toString();n.html($("<iframe allowfullscreen></iframe>").attr("src",t).width(800).height(535)),$("div.information-right.fl-r.clearfix").remove(),document.querySelector("div.di-b>a").setAttribute("href","../episode");const o=parseInt($("li.btn-anime:last span.episode-number")[0].innerText.split(" ")[1]);if(o<animeEpisodes){const e=document.querySelector("#vue-video-slide"),n=$("li.btn-anime:last").clone().removeClass("play").remove("span.icon-pay");n.find("div.text").html('<span class="episode-number"></span>'),n.find("img.fl-l").attr("src","http://www.stylemefancy.com/wp-content/themes/pinnace12/assets/images/no-thumbnail-medium.png");for(let t=o;t<animeEpisodes;t++){const o=n.clone(),i=(t+1).toString();o.find("span.episode-number").text("Episode "+i),o.find("a.link").attr("href",i),o.appendTo(e)}}}else{console.log("Creating new video embed and page content");const n=yield $.get(grobberUrl+"/templates/mal/episode/"+animeUID+"/"+(e-1).toString());document.querySelector("td>div.js-scrollfix-bottom-rel>div>div>table>tbody").innerHTML=n}document.querySelector("#vue-video-slide").style.left=(-document.querySelector("li.btn-anime.play").offsetLeft).toString()+"px"});return function(){return e.apply(this,arguments)}})(),showAnimeEpsiodes=(()=>{var e=_asyncToGenerator(function*(){let e=document.querySelector("table.episode_list");if(e){console.log("Manipulating existing episode table...");const n=e.querySelectorAll("tr.episode-list-data").length;if(n<animeEpisodes){const t=document.querySelector("table.episode_list.descend tr.episode-list-header"),o=document.querySelector("tr.episode-list-data").cloneNode(!0);o.querySelector("td.episode-title").querySelector("span.di-ib").innerText="",o.querySelector("td.episode-aired").remove(),o.querySelector("td.episode-forum").remove();for(let i=n;i<animeEpisodes;i++){let n=(i+1).toString(),a=$(o).clone();a.find("td.episode-number").text(n),a.find("td.episode-title").find("a").text("Episode "+n).attr("href","episode/"+n),a.find("td.episode-video>a").attr("href","episode/"+n).find("img").attr("alt","Watch Episode #"+n),a.appendTo(e),a.clone().insertAfter(t)}}}else{console.log("Recreating episode table...");const e=yield $.get(grobberUrl+"/templates/mal/episode/"+animeUID);document.querySelector("div.mb4").outerHTML=e}const n=document.querySelector("h2>span.di-ib");n.innerText="("+animeEpisodes.toString()+"/"+n.innerText.split("/")[1]});return function(){return e.apply(this,arguments)}})(),getAnimeInfo=(()=>{var e=_asyncToGenerator(function*(){if(animeName=document.querySelector("h1>span[itemprop=name]").innerText,animeUID=localStorage.getItem(animeName)){const e=yield $.getJSON(grobberUrl+"/anime/"+animeUID);if(e.success)return animeEpisodes=e.episodes,!0;console.warn('Unsuccessful request for uid "'+animeUID+'":',e)}console.log("Searching for anime",animeName);const e=yield $.getJSON(grobberUrl+"/search/"+animeName,{dub:yield config.dub});if(!e.success||0===e.anime.length)return console.error("Couldn't find anime \""+animeName+'"'),!1;console.log("got answer",e);const n=e.anime[0].anime;return animeUID=n.uid,animeEpisodes=n.episodes,localStorage.setItem(animeName,animeUID),!0});return function(){return e.apply(this,arguments)}})(),getCurrentlyWatchingAnimeList=(()=>{var e=_asyncToGenerator(function*(){let e;for(;!e||e.length<=1;)e=$("table.list-table tbody.list-item"),yield sleep(20);const n=e.filter(function(e,n){return $(n).find("td.data.status").hasClass("watching")}),t=[];for(const e of n)t.push(new AnimeListEntry($(e)));return t});return function(){return e.apply(this,arguments)}})(),highlightAnimeWithUnwatchedEpisodes=(()=>{var e=_asyncToGenerator(function*(){const e=yield getCurrentlyWatchingAnimeList(),n=[];for(item of e)item.uid&&n.push(item);const t=yield postJSON(grobberUrl+"/anime/episode-count",n);console.log(t)});return function(){return e.apply(this,arguments)}})(),loadConfig=(()=>{var e=_asyncToGenerator(function*(){if(Raven.captureBreadcrumb({message:"loading config...",level:"info",category:"config"}),Object.assign(_config,default_config),username){let e;try{e=yield $.getJSON(grobberUrl+"/user/"+username+"/config")}catch(e){Raven.captureMessage("Couldn't retrieve config.",{level:"warning",extra:{error:e}})}e&&e.success&&Object.assign(_config,e.config)}Raven.captureBreadcrumb({message:"loaded config",data:{config:_config},level:"info",category:"config"})});return function(){return e.apply(this,arguments)}})(),saveConfig=(()=>{var e=_asyncToGenerator(function*(){const e=yield postJSON(grobberUrl+"/user/"+username+"/config",JSON.stringify(_config));return e.success?(console.log("saved config"),!0):(Raven.captureMessage("Couldn't save config.",{level:"warning",extra:{response:e}}),!1)});return function(){return e.apply(this,arguments)}})(),showSettings=(()=>{var e=_asyncToGenerator(function*(){console.log("Building settings page"),document.querySelector("div#horiznav_nav a[href$=myanimestream]").classList.add("horiznav_active"),document.querySelector("div#content div form").parentElement.innerHTML=yield $.get(grobberUrl+"/templates/mal/settings",yield config.all),document.querySelector("input[name=submit]").addEventListener("click",submitSettings)});return function(){return e.apply(this,arguments)}})(),submitSettings=(()=>{var e=_asyncToGenerator(function*(){$("div#content div form").serializeArray().forEach(function(e){config[e.name]=formParseValue(e.value)}),(yield saveConfig())?$("#update_success_display").show():$("#update_fail_display").show()});return function(){return e.apply(this,arguments)}})();function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){return function o(i,a){try{var r=n[i](a),s=r.value}catch(e){return void t(e)}if(!r.done)return Promise.resolve(s).then(function(e){o("next",e)},function(e){o("throw",e)});e(s)}("next")})}}const grobberUrl="//localhost",ravenDSN="https://1d91640d1e45402c9a8f80e74c24658b@sentry.io/1207280",adSearch=["Notice us","ads help us pay the bills"];function adRemove(){Array.from(document.getElementsByTagName("*")).filter(e=>{if(!e.firstChild)return;let n=e.firstChild.nodeValue;return n?Boolean(adSearch.find(e=>n.includes(e))):void 0}).forEach(e=>{for(let n=0;n<5;n++)e=e.parentElement;console.log("removed ad",e),e.remove()})}function observe(){new MutationObserver(adRemove).observe(document.body,{childList:!0}),console.log("observing body!"),adRemove()}function isMobilePage(){let e=null;return null===e&&(e=!!document.querySelector("a.footer-desktop-button")),e}function setupPlatform(){console.log("settings up platform"),isMobilePage()&&(console.log("running on mobile version"),alert("The mobile version of this script is still in development."))}const settingPaths=["/editprofile.php","/notification/setting","/ownlist/style","/account/payment"];function sleep(e){return new Promise(n=>setTimeout(n,e))}function _animeNotFoundMsg(){const e=animeName.replace(/\W+/g,"").toLowerCase();console.log(e);const n="already-warned-"+e;if(Cookies.get(n))console.log("Already warned about missing anime");else{let e="Couldn't find \""+animeName+'"!';Raven.isSetup()&&(e+=" A report has been created for you and you can expect for this anime to be available soon",Raven.captureMessage('Anime "'+animeName+'" not found.',{level:"info"})),Cookies.set(n,"true",{expires:1}),alert(e)}}function patchNoEpisodeTab(){if(!document.querySelector('li a[href$="/episode"]')){console.log("No Episodes tab found, building my own");const e=document.querySelector("div#horiznav_nav li:nth-child(2)"),n=$("<li><a href="+window.location.pathname+"/episode/1>Watch</a></li>");document.querySelector("a.horiznav_active")||n.find("a").addClass("horiznav_active"),n.insertAfter(e)}}function showAnimeDetails(){const e=document.getElementById("myinfo_watchedeps"),n=parseInt(e.getAttribute("value"))+1||1;n<=animeEpisodes&&$("<a></a>").text((1===n?"Start":"Continue")+" Watching").addClass("inputButton btn-middle").css("padding","4px 12px").css("margin-left","8px").click(()=>window.location.pathname+="/episode/"+n.toString()).appendTo($("div.user-status-block.js-user-status-block"))}let animeName,animeUID,animeEpisodes;class AnimeListEntry{constructor(e){this.el=e}get name(){return this.el.find("td.title a.link").text()}get uid(){return localStorage.getItem(this.name)}}const default_config={dub:!1,replaceStream:!1},_config={};let _configReady=!1;const _configHandler={get:(e,n)=>_asyncToGenerator(function*(){return"all"===n?(_configReady||(yield loadConfig(),_configReady=!0),_config):n in e?e[n]:(_configReady||(yield loadConfig(),_configReady=!0),_config[n])})()},config=new Proxy(_config,_configHandler);function addSettingsButton(){const e=document.querySelector("div#horiznav_nav ul");if(e){console.log("Attaching MyAnimeStream settings");const n=document.createElement("li"),t=document.createElement("a");t.setAttribute("href","/editprofile.php?go=myanimestream"),t.innerText="MyAnimeStream",n.appendChild(t),e.appendChild(n)}else console.log("Couldn't find navbar. Not adding Settings!"),Raven.captureMessage("Couldn't add MyAnimeStream settings button (nav not found)",{level:"warning"})}function formParseValue(e){switch(e){case"true":return!0;case"false":return!1}}let username;function addUserContext(){if(Raven.isSetup()){const e=document.querySelector("a.header-profile-link");e?(username=e.text,console.log("Set user context."),Raven.setUserContext({username:username,mobile:isMobilePage()})):console.log("Not logged in")}}function init(){setupPlatform(),observe(),addUserContext(),route()}function _init(){$(init)}Raven.config(ravenDSN,{release:GM_info.script.version,tags:{manager_version:GM_info.version}}).install(),console.info("Using Raven DSN!"),Raven.context(_init);
