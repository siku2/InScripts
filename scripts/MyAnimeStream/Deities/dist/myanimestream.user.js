// ==UserScript==
// @name MyAnimeStream
// @author siku2
// @version 1.0.3
// @description Get the most out of MyAnimeList by turning the page into a streaming site.
// @homepage https://siku2.github.io/
// @downloadURL https://github.com/siku2/InScripts/raw/master/scripts/MyAnimeStream/Deities/dist/myanimestream.user.js
// @icon https://myanimelist.cdn-dena.com/img/sp/icon/apple-touch-icon-256.png
// @include /^http(?:s)?\:\/\/myanimelist\.net.*$/
// @noframes True
// @run-at document-start
// @require https://code.jquery.com/jquery-3.2.1.min.js
// @require https://cdn.ravenjs.com/3.25.1/raven.min.js
// @require https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js
// @require https://cdn.plyr.io/3.3.10/plyr.js
// ==/UserScript==
let route=(()=>{var e=_asyncToGenerator(function*(){const e=window.location.pathname,t=window.location.search;if(settingPaths.indexOf(e)>-1&&addSettingsButton(),e.match(/^\/anime\/\d+\/[\w-]+\/?/)){if(patchNoEpisodeTab(),!(yield getAnimeInfo()))return void _animeNotFoundMsg()}e.match(/^\/anime\/\d+\/[\w-]+\/?$/)?showAnimeDetails():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/?$/)?showAnimeEpsiodes():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/\d+\/?$/)?showAnimeEpisode():e.match(/^\/animelist\/\w+$/)?highlightAnimeWithUnwatchedEpisodes():e.match(/^\/editprofile\.php$/)&&t.match(/^\?go=myanimestream$/)&&showSettings()});return function(){return e.apply(this,arguments)}})(),postJSON=(()=>{var e=_asyncToGenerator(function*(e,t){return yield $.ajax({type:"POST",contentType:"application/json",url:e,data:JSON.stringify(t)})});return function(t,n){return e.apply(this,arguments)}})(),updateAnimeStatus=(()=>{var e=_asyncToGenerator(function*(e){const t=$("#myinfo_status"),n=$("#myinfo_score"),i=$("#myinfo_watchedeps"),o={csrf_token:$('meta[name="csrf_token"]').attr("content"),anime_id:parseInt($("#myinfo_anime_id").val()),status:parseInt(t.val()),score:parseInt(n.val()),num_watched_episodes:parseInt(i.val())||0};Object.assign(o,e),yield $.post("/ownlist/anime/edit.json",JSON.stringify(o)),t.val(o.status),n.val(o.score),i.val(o.num_watched_episodes)});return function(t){return e.apply(this,arguments)}})(),finishedEpisode=(()=>{var e=_asyncToGenerator(function*(){(yield config.updateEpisodesSeen)||console.log("Not updating anime status because of user settings");const e={status:1},t=parseInt($("#myinfo_watchedeps").val())||0;currentEpisodeIndex>=t&&(e.num_watched_episodes=currentEpisodeIndex),console.log("updating data to:",e),yield updateAnimeStatus(e)});return function(){return e.apply(this,arguments)}})(),onVideoEnd=(()=>{var e=_asyncToGenerator(function*(){if(yield finishedEpisode(),currentEpisodeIndex+1<animeEpisodes){const e=new URL((currentEpisodeIndex+1).toString(),window.location.href);e.searchParams.set("autoplay","true"),window.location.href=e.toString()}else console.log("reached the last episode")});return function(){return e.apply(this,arguments)}})(),onPageLeave=(()=>{var e=_asyncToGenerator(function*(e){if(!currentPlayer.ended){const e=currentPlayer.currentTime/currentPlayer.duration;e>(yield config.minWatchPercentageForSeen)&&(console.log("Left page with video at "+Math.round(100*e).toString()+"% Counting as finished!"),yield finishedEpisode())}});return function(t){return e.apply(this,arguments)}})(),createPlayer=(()=>{var e=_asyncToGenerator(function*(e){const t=yield $.get(grobberUrl+"/stream/"+animeUID+"/"+(currentEpisodeIndex-1).toString());e.html(t),setupPlyr()});return function(t){return e.apply(this,arguments)}})(),showAnimeEpisode=(()=>{var e=_asyncToGenerator(function*(){currentEpisodeIndex=parseInt(window.location.pathname.match(/^\/anime\/\d+\/[\w-]+\/episode\/(\d+)\/?$/)[1]);const e=$("div.video-embed.clearfix");if(e.length>0){(yield config.replaceStream)?(console.log("Manipulating player"),createPlayer(e),$("div.information-right.fl-r.clearfix").remove()):console.info("Not changing player because of user settings"),document.querySelector("div.di-b>a").setAttribute("href","../episode");const t=parseInt($("li.btn-anime:last span.episode-number")[0].innerText.split(" ")[1]);if(t<animeEpisodes){const e=document.querySelector("#vue-video-slide"),n=$("li.btn-anime:last").clone().removeClass("play").remove("span.icon-pay");n.find("div.text").html('<span class="episode-number"></span>'),n.find("img.fl-l").attr("src","http://www.stylemefancy.com/wp-content/themes/pinnace12/assets/images/no-thumbnail-medium.png");for(let i=t;i<animeEpisodes;i++){const t=n.clone(),o=(i+1).toString();t.find("span.episode-number").text("Episode "+o),t.find("a.link").attr("href",o),t.appendTo(e)}}}else console.log("Creating new video embed and page content"),document.querySelector("td>div.js-scrollfix-bottom-rel>div>div>table>tbody").innerHTML=yield $.get(grobberUrl+"/templates/mal/episode/"+animeUID+"/"+(currentEpisodeIndex-1).toString()),setupPlyr();document.querySelector("#vue-video-slide").style.left=(-document.querySelector("li.btn-anime.play").offsetLeft).toString()+"px"});return function(){return e.apply(this,arguments)}})(),showAnimeEpsiodes=(()=>{var e=_asyncToGenerator(function*(){let e=document.querySelector("table.episode_list");if(e){console.log("Manipulating existing episode table...");const t=e.querySelectorAll("tr.episode-list-data").length;if(t<animeEpisodes){const n=document.querySelector("table.episode_list.descend tr.episode-list-header"),i=document.querySelector("tr.episode-list-data").cloneNode(!0);i.querySelector("td.episode-title").querySelector("span.di-ib").innerText="",i.querySelector("td.episode-aired").remove(),i.querySelector("td.episode-forum").remove();for(let o=t;o<animeEpisodes;o++){let t=(o+1).toString(),r=$(i).clone();r.find("td.episode-number").text(t),r.find("td.episode-title").find("a").text("Episode "+t).attr("href","episode/"+t),r.find("td.episode-video>a").attr("href","episode/"+t).find("img").attr("alt","Watch Episode #"+t),r.appendTo(e),r.clone().insertAfter(n)}}}else console.log("Recreating episode table..."),document.querySelector("div.mb4").outerHTML=yield $.get(grobberUrl+"/templates/mal/episode/"+animeUID);const t=document.querySelector("h2>span.di-ib");t.innerText="("+animeEpisodes.toString()+"/"+t.innerText.split("/")[1]});return function(){return e.apply(this,arguments)}})(),getAnimeInfo=(()=>{var e=_asyncToGenerator(function*(){if(animeName=document.querySelector("h1>span[itemprop=name]").innerText,animeUID=localStorage.getItem(animeName)){const e=yield $.getJSON(grobberUrl+"/anime/"+animeUID);if(e.success)return animeEpisodes=e.episodes,!0;console.warn('Unsuccessful request for uid "'+animeUID+'":',e)}console.log("Searching for anime",animeName);const e=yield $.getJSON(grobberUrl+"/search/"+animeName,{dub:yield config.dub});if(!e.success||0===e.anime.length)return console.error("Couldn't find anime \""+animeName+'"'),!1;console.log("got answer",e);const t=e.anime[0].anime;return animeUID=t.uid,animeEpisodes=t.episodes,localStorage.setItem(animeName,animeUID),!0});return function(){return e.apply(this,arguments)}})(),getCurrentlyWatchingAnimeList=(()=>{var e=_asyncToGenerator(function*(){let e;for(;!e||e.length<=1;)e=$("table.list-table tbody.list-item"),yield sleep(100);const t=e.filter(function(e,t){return $(t).find("td.data.status").hasClass("watching")}),n=[];for(const e of t)n.push(new AnimeListEntry($(e)));return n});return function(){return e.apply(this,arguments)}})(),highlightAnimeWithUnwatchedEpisodes=(()=>{var e=_asyncToGenerator(function*(){injectBalloonCSS();const e=yield getCurrentlyWatchingAnimeList(),t={};for(item of e)item.uid&&(t[item.uid]=item);const n=yield postJSON(grobberUrl+"/anime/episode-count",Object.keys(t));n.success?(Object.entries(n.anime).forEach(function([e,n]){return t[e].latestEpisode=n}),e.forEach(function(e){return e.show()}),$.injectCSS({"span.episode-status.new-episode":{"font-weight":"bolder",color:"#787878 !important"}})):console.warn("Got turned down when asking for episode counts: ",n)});return function(){return e.apply(this,arguments)}})(),loadConfig=(()=>{var e=_asyncToGenerator(function*(){if(Raven.captureBreadcrumb({message:"loading config...",level:"info",category:"config"}),Object.assign(_config,default_config),username){let e;try{e=yield $.getJSON(grobberUrl+"/user/"+username+"/config")}catch(e){Raven.captureMessage("Couldn't retrieve config.",{level:"warning",extra:{error:e}})}e&&e.success&&Object.assign(_config,e.config)}Raven.captureBreadcrumb({message:"loaded config",data:{config:_config},level:"info",category:"config"})});return function(){return e.apply(this,arguments)}})(),saveConfig=(()=>{var e=_asyncToGenerator(function*(){const e=yield postJSON(grobberUrl+"/user/"+username+"/config",JSON.stringify(_config));return e.success?(console.log("saved config"),!0):(Raven.captureMessage("Couldn't save config.",{level:"warning",extra:{response:e}}),!1)});return function(){return e.apply(this,arguments)}})(),showSettings=(()=>{var e=_asyncToGenerator(function*(){console.log("Building settings page"),document.querySelector("div#horiznav_nav a[href$=myanimestream]").classList.add("horiznav_active"),document.querySelector("div#content div form").parentElement.innerHTML=yield $.get(grobberUrl+"/templates/mal/settings",yield config.all),document.querySelector("input[name=submit]").addEventListener("click",submitSettings)});return function(){return e.apply(this,arguments)}})(),submitSettings=(()=>{var e=_asyncToGenerator(function*(){$("div#content div form").serializeArray().forEach(function(e){config[e.name]=formParseValue(e.value)}),(yield saveConfig())?$("#update_success_display").show():$("#update_fail_display").show()});return function(){return e.apply(this,arguments)}})();function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function i(o,r){try{var a=t[o](r),s=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(s).then(function(e){i("next",e)},function(e){i("throw",e)});e(s)}("next")})}}const grobberUrl="https://mas.dokkeral.com",ravenDSN="https://1d91640d1e45402c9a8f80e74c24658b@sentry.io/1207280",adSearch=["Notice us","ads help us pay the bills"];function adRemove(){Array.from(document.getElementsByTagName("*")).filter(e=>{if(!e.firstChild)return;let t=e.firstChild.nodeValue;return t?Boolean(adSearch.find(e=>t.includes(e))):void 0}).forEach(e=>{for(let t=0;t<5;t++)e=e.parentElement;console.log("removed ad",e),e.remove()})}function observe(){new MutationObserver(adRemove).observe(document.body,{childList:!0}),console.log("observing body!"),adRemove()}function isMobilePage(){let e=null;return null===e&&(e=!!document.querySelector("a.footer-desktop-button")),e}function setupPlatform(){console.log("settings up platform"),isMobilePage()&&(console.log("running on mobile version"),alert("The mobile version of this script is still in development."))}const settingPaths=["/editprofile.php","/notification/setting","/ownlist/style","/account/payment"];function sleep(e){return new Promise(t=>setTimeout(t,e))}function _animeNotFoundMsg(){const e=animeName.replace(/\W+/g,"").toLowerCase();console.log(e);const t="already-warned-"+e;if(Cookies.get(t))console.log("Already warned about missing anime");else{let e="Couldn't find \""+animeName+'"!';Raven.isSetup()&&(e+=" A report has been created for you and you can expect for this anime to be available soon",Raven.captureMessage('Anime "'+animeName+'" not found.',{level:"info"})),Cookies.set(t,"true",{expires:1}),alert(e)}}function injectBalloonCSS(){$('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/balloon-css/0.5.0/balloon.min.css">').appendTo("head")}function patchNoEpisodeTab(){if(!document.querySelector('li a[href$="/episode"]')){console.log("No Episodes tab found, building my own");const e=document.querySelector("div#horiznav_nav li:nth-child(2)"),t=$("<li><a href="+window.location.pathname+"/episode/1>Watch</a></li>");document.querySelector("a.horiznav_active")||t.find("a").addClass("horiznav_active"),t.insertAfter(e)}}function showAnimeDetails(){const e=document.getElementById("myinfo_watchedeps"),t=parseInt(e.getAttribute("value"))+1||1;t<=animeEpisodes&&$("<a></a>").text((1===t?"Start":"Continue")+" Watching").addClass("inputButton btn-middle").css("padding","4px 12px").css("margin-left","8px").click(()=>window.location.pathname+="/episode/"+t.toString()).appendTo($("div.user-status-block.js-user-status-block"))}let currentPlayer,currentEpisodeIndex,animeName,animeUID,animeEpisodes;function setupPlyr(){document.getElementById("player")?((currentPlayer=new Plyr("#player")).on("ended",onVideoEnd),window.addEventListener("beforeunload",onPageLeave),console.log(currentPlayer)):console.warn("Couldn't find player, assuming this is an embed!")}class AnimeListEntry{constructor(e){this.el=e}get name(){return this.el.find("td.title a.link").text()}get link(){return this.el.find("td.title a.link").attr("href")}get uid(){return localStorage.getItem(this.name)}get uidValid(){return this.uid&&void 0!==this._latestEpisode}get airing(){return"Airing"===this.el.find("span.content-status").text().trim()}get latestEpisode(){return this._latestEpisode}set latestEpisode(e){this._latestEpisode=e}get currentEpisode(){return parseInt(this.el.find("td.progress span a").text())}get nNewEpisodes(){return this.latestEpisode?this.latestEpisode-this.currentEpisode:0}show(){let e,t,n;const i=["content-status","episode-status"];if(this.uidValid?this.nNewEpisodes>0&&this.airing&&(e=1===this.nNewEpisodes?"new episode!":"new episodes!",i.push("new-episode"),t="There "+(1===this.nNewEpisodes?"is an episode":"are "+this.nNewEpisodes.toString()+" episodes")+" you haven't watched yet!",n=(()=>window.location.pathname=this.link+"/episode/"+(this.currentEpisode+1).toString())):this.uid?(e="uid invalid",t="There was an UID cached but the server didn't accept it. Just open the anime page and it should fix itself"):(e="unknown uid",t="There was no UID cached. Just open the anime page and it should fix itself"),e){const o=this.el.find("td.title span.content-status");o.is(":visible")&&(e="| "+e);const r=$("<span></span>").text(e);i.forEach(e=>r.addClass(e)),t&&(r.attr("data-balloon-pos","up"),r.attr("data-balloon",t)),n&&r.click(n),o.after(r)}}}!function(jQuery){"use strict";function toCSS(jss,options){function jsonToCSS(e,t){for(var n in e&&!result[e]&&(result[e]={}),t){var i=t[n];if(i instanceof Array)for(var o=i,r=0;r<o.length;r++)addProperty(e,n,o[r]);else switch(typeof i){case"number":case"string":addProperty(e,n,i);break;case"object":var a=n.charAt(n.length-1);if(!e||"_"!==a&&"-"!==a)jsonToCSS(makeSelectorName(e,n),i);else{var s=i;for(var l in s)for(var c=l.split(/\s*,\s*/),d=0;d<c.length;d++){var u=s[l];if(u instanceof Array)for(var p=u,f=0;f<p.length;f++)addProperty(e,n+c[d],p[f]);else addProperty(e,n+c[d],s[l])}}}}}function makePropertyName(e){return e.replace(/_/g,"-")}function makeSelectorName(e,t){for(var n=[],i=t.split(/\s*,\s*/),o=e.split(/\s*,\s*/),r=0;r<o.length;r++)for(var a=o[r],s=0;s<i.length;s++){var l=i[s];"&"===l.charAt(0)?n.push(a+l.substr(1)):n.push(a?a+" "+l:l)}return n.join(", ")}function addProperty(e,t,n){"number"!=typeof n||options.useRawValues||(n+="px");for(var i=t.split(/\s*,\s*/),o=0;o<i.length;o++){var r=makePropertyName(i[o]);result[e][r]?result[e][r].push(n):result[e][r]=[n]}}var result={};if("string"==typeof jss)try{eval("var jss = {"+jss+"}")}catch(e){return"/*\nUnable to parse JSS: "+e+"\n*/"}jsonToCSS("",jss);var ret="";for(var a in result){var css=result[a];for(var i in ret+=a+" {\n",css)for(var values=css[i],j=0;j<values.length;j++)ret+="\t"+i+": "+values[j]+";\n";ret+="}\n"}return ret}var defaults={truncateFirst:!1,container:null,containerName:"injectCSSContainer",useRawValues:!1};jQuery.injectCSS=function(e,t){(t=jQuery.extend({},defaults,t)).media=t.media||"all";var n=t.container&&jQuery(t.container)||jQuery("#"+t.containerName);n.length||(n=jQuery("<style></style>").appendTo("head").attr({media:t.media,id:t.containerName,type:"text/css"}));var i=n[0],o=void 0!==i.styleSheet&&void 0!==i.styleSheet.cssText,r="";return t.truncateFirst||(r+=o?i.styleSheet.cssText:n.text()),r+=toCSS(e,t),o?i.styleSheet.cssText=r:n.text(r),n}}(jQuery);const default_config={dub:!1,replaceStream:!0,updateEpisodesSeen:!0,minWatchPercentageForSeen:.75},_config={};let _configReady=!1;const _configHandler={get:(e,t)=>_asyncToGenerator(function*(){return"all"===t?(_configReady||(yield loadConfig(),_configReady=!0),_config):t in e?e[t]:(_configReady||(yield loadConfig(),_configReady=!0),_config[t])})()},config=new Proxy(_config,_configHandler);function addSettingsButton(){const e=document.querySelector("div#horiznav_nav ul");if(e){console.log("Attaching MyAnimeStream settings");const t=document.createElement("li"),n=document.createElement("a");n.setAttribute("href","/editprofile.php?go=myanimestream"),n.innerText="MyAnimeStream",t.appendChild(n),e.appendChild(t)}else console.log("Couldn't find navbar. Not adding Settings!"),Raven.captureMessage("Couldn't add MyAnimeStream settings button (nav not found)",{level:"warning"})}function formParseValue(e){switch(e){case"true":return!0;case"false":return!1}}let username;function addUserContext(){if(Raven.isSetup()){const e=document.querySelector("a.header-profile-link");e?(username=e.text,console.log("Set user context."),Raven.setUserContext({username:username,mobile:isMobilePage()})):console.log("Not logged in")}}function init(){setupPlatform(),observe(),addUserContext(),route()}function _init(){$(init)}ravenDSN?(Raven.config(ravenDSN,{release:GM_info.script.version,tags:{manager_version:GM_info.version}}).install(),console.info("Using Raven DSN!"),Raven.context(_init)):(console.warn("No Raven DSN provided, not installing!"),_init());
